<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ein Leitfaden für moderne Best Practices in der Entwicklung mit Contao">

		<title>Contao - wie geht es heute?</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/dracula.css" id="theme-stylesheet">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
    <style>
      .theme__switches {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        position: fixed;
        inset: 10px 10px auto auto;
        z-index: 2;
      }

      .color__switch {
        position: relative;
        cursor: pointer;
        font-size: 3.25px;
        height: 8em;
        width: 15em;
        border-radius: 50px 0 0 50px;

        transition: all .5s ease;
        background: #282a36;
        box-shadow: inset 0 0 0 2px #fff;

        label {
          position: absolute;
          inset:0;
          cursor: pointer;
          text-indent: -999em;
        }

        input {
          all: unset;
          pointer-events: none;
          position: absolute;
          display: block;
          border-radius: 50%;
          transition: all 0.4s ease-in-out;
          top: 1.5em;
          left: 1.5em;
          transform: rotate(-75deg);
          width: 5em;
          height: 5em;
          background: #282a36;
          box-shadow: 0.75em 0.625em 0 0 #d9fbff inset,
          rgba(255, 255, 255, 0.1) 0 -1.75em 0 -2.25em,
          rgba(255, 255, 255, 0.1) 1.5em 3.5em 0 -2.25em,
          rgba(255, 255, 255, 0.1) 1em 6.5em 0 -2em,
          rgba(255, 255, 255, 0.1) 3em 1em 0 -2.05em,
          rgba(255, 255, 255, 0.1) 4em 4em 0 -2.25em,
          rgba(255, 255, 255, 0.1) 3em 6.5em 0 -2.25em,
          rgba(255, 255, 255, 0.1) -2em 3.6em 0 -2.25em,
          rgba(255, 255, 255, 0.1) -.5em 5em 0 -2.25em;

          &:checked {
            top: 2.25em;
            left: 9em;
            transform: rotate(0deg);
            width: 3.5em;
            height: 3.5em;
            background: #fff;
            box-shadow:
              1.5em 1.5em 0 2.5em #fff inset,
              0 -2.5em 0 -1.35em #fff,
              1.75em -1.75em 0 -1.5em #fff,
              2.5em 0 0 -1.35em #fff,
              1.75em 1.75em 0 -1.5em #fff,
              0 2.5em 0 -1.35em #fff,
              -1.75em 1.75em 0 -1.5em #fff,
              -2.5em 0 0 -1.35em #fff,
              -1.75em -1.75em 0 -1.5em #fff;
          }
        }
      }

      .theme__select {
        label {
          position: absolute;
          inset: 0;
          opacity: 0;
          pointer-events: none;
        }
        select {
          cursor: pointer;
          height: 26px;
          background: #282a36;
          color: #fff;
          border-radius: 0 50px 50px 0;
          border: 2px solid #fff;
          border-left-width: 0;
          padding: 2px 8px;
          max-width: 100px;
          text-overflow: ellipsis;
        }
      }
    </style>
	</head>
	<body>
  <div class="theme__switches">
    <div class="color__switch">
      <input id="color-toggle" type="checkbox" />
      <label for="color-toggle">Toggle Dark/Light Mode</label>
    </div>
    <div class="theme__select">
      <label class="" for="theme-select">Themes</label>
      <select id="theme-select">
        <option value="">-</option>
        <option value="beige.css">Beige</option>
        <option value="black.css">Black</option>
        <option value="black-contrast.css">Black Contrast</option>
        <option value="blood.css">Blood</option>
        <option value="league.css">League</option>
        <option value="moon.css">Moon</option>
        <option value="night.css">Night</option>
        <option value="serif.css">Serif</option>
        <option value="simple.css">Simple</option>
        <option value="sky.css">Sky</option>
        <option value="solarized.css">Solarized</option>
        <option value="white-contrast.css">White Contrast</option>
        <option value="white_contrast_compact_verbatim_headers.css">White Compact</option>
      </select>
    </div>
  </div>

  <script>
    const themeLink = document.getElementById('theme-stylesheet');
    const toggle = document.getElementById('color-toggle');
    const select = document.getElementById('theme-select');

    const setTheme = (file) => {
      themeLink.href = 'dist/theme/' + file;
      localStorage.setItem('themeFile', file);
    };

    const saved = localStorage.getItem('themeFile');
    if (saved) {
      setTheme(saved);
      toggle.checked = saved === 'white.css';
      if (saved !== 'white.css' && saved !== 'dracula.css') {
        select.value = saved;
      } else {
        select.value = '';
      }
    }

    toggle.addEventListener('change', () => {
      setTheme(toggle.checked ? 'white.css' : 'dracula.css');
      select.value = '';
    });

    select.addEventListener('change', () => {
      if (select.value) {
        setTheme(select.value);
        toggle.checked = select.value === 'white.css';
      }
    });
  </script>

  <div class="reveal">
    <div class="slides">

      <section id="welcome" data-transition="fade">

        <section data-transition="fade">
          <h1>Contao - wie geht es heute?</h1>
          <p style="font-size: smaller">Ein Leitfaden für moderne Best Practices in der Entwicklung mit Contao</p>

          <aside class="notes">
            <ul>
              <li>Reise eines Refactorings inklusive Teilmodernisierung von zwei verwaisten Contao 3 Modulen</li>
              <li>Vortrag richtet sich an Entwickler oder solche, die es gerne werden möchten</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Sebastian Zoglowek</h2>
          <ul>
            <li>Nickname: zoglo (GitHub, Forum, Slack, überall)</li>
            <li>Fullstack-Entwickler</li>
            <li>Erste Eindrücke seit Contao 4.8 (2019)</li>
            <li>Contao Core-Entwickler seit Februar 2025</li>
            <li>Oveleon GbR</li>
            <li>#Darkmode</li>
          </ul>

          <aside class="notes">
            <ul>
              <li>Programmierung erst seit 2021, vorher CSS</li>
              <li>Konferenz '23 Startschuss für Contributions in Contao</li>
              <li>Seit Ende 2023 vermehrt Contributions</li>
              <li>Bekannt für Dark-Mode in der Doku und im Manager</li>
            </ul>
          </aside>
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="agenda" data-transition="fade">
        <h2>Agenda</h2>
        <ol>
          <li>Warum überhaupt?</li>
          <li>Service Container anstatt $GLOBALS
            <ul>
              <li>Service Tagging in Contao</li>
            </ul>
          </li>
          <li>Permissions mit Votern</li>
          <li>Events statt Hooks</li>
          <li>Rector (und weitere Tools)</li>
          <li style="opacity: .7"><span >Rector Regeln schreiben</span></li>
        </ol>

        <aside class="notes">
          <ul>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
          </ul>
        </aside>
      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="why" data-transition="fade">

        <section data-transition="fade">
          <h2>Warum?</h2>
          <ul>
            <li>Symfony seit Contao 4 und seit Jahren etabliert</li>
            <li>Das Rad nicht neu erfinden</li>
            <li>Standards nutzen</li>
          </ul>

          <aside class="notes">
            <ul>
              <li>Wer liest Release Notes</li>
              <li>Wer verfolgt alle Pull Requests auf GitHub?</li>
              <li>Wer schaut sich alle neuen Features in PHP und Symfony an?</li>
              <li>Wer hat noch eigene alte Erweiterungen in system/modules</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Das News-Bundle</h2>

          <pre><code class="php" data-trim>
class ModuleNewsReader extends ModuleNews
{

  public function generate()
	{
		if (TL_MODE == 'BE')
		{
			$objTemplate = new BackendTemplate('be_wildcard');

			$objTemplate->wildcard = '### NEWS READER ###';
			$objTemplate->title = $this->headline;
			$objTemplate->id = $this->id;
			$objTemplate->link = $this->name;
			$objTemplate->href = 'contao/main.php?do=themes&amp;table=tl_module&amp;act=edit&amp;id=' . $this->id;

			return $objTemplate->parse();
		}

		// Return if no news item has been specified
		if (!$this->Input->get('items'))
		{
			return '';
		}

		$this->news_archives = $this->sortOutProtected(deserialize($this->news_archives));

		// Return if there are no archives
		if (!is_array($this->news_archives) || count($this->news_archives) < 1)
		{
			return '';
		}

		return parent::generate();
	}
</code></pre>

          <aside class="notes">
            <ul>
              <li>Core-Devs sagen immer: Schau es dir am Core ab</li>
              <li>Selber am News-Bundle gelernt</li>
              <li>Schönes Beispiel um Liste und Detail-Seite darzustellen</li>
              <li>Das Code-Beispiel ist von 2008...</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Das News-Bundle (als schlechtes Beispiel)</h2>

          <img src="images/news-bundle.png" alt="News-Bundle Commit 2008" style="width: 100%">

          <a href="https://github.com/contao/core/commit/4a2809d34ce08193c26b1c5815ecad2c1cdb909b">Der erste commit</a>

          <aside class="notes">
            <ul>
              <li>News Bundle ist veraltet - Die Leute von Contao machen es ja gut</li>
              <li>Ende 2021 habe ich gelernt, wie man Code von 2008 schreibt</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Best Practices - seit 2016</h2>

          <div style="margin-bottom: 1em">
            <strong>2016 - Contao 4 Extension Development</strong>
            <p>(David Greminger)</p>
            <p><a href="https://www.youtube.com/watch?v=hrFnud6CtLg" target="_blank" title="Contao 4 Extension Development - Contao Konferenz 2016">Video zum Konferenzvortrag</a></p>
          </div>
          <div style="margin-bottom: 1em">
            <strong>2017 - Extension from scratch in Contao 4</strong>
            <p>(Christian Schiffler)</p>
            <p><a href="https://www.youtube.com/watch?v=hrFnud6CtLg" target="_blank" title="Contao 4 Extension Development - Contao Konferenz 2016">Video zum Konferenzvortrag</a></p>
          </div>

          <aside class="notes">
            <ul>
              <li>Best practices gibt es seit 2016 - Symfony</li>
            </ul>
          </aside>
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="revival" data-transition="fade">

        <section data-transition="fade">
          <h2>Zwei verwaiste Plugins als Beispiel</h2>
        </section>

        <section data-transition="fade">

          <img src="images/graveyard.png" alt="Image graveyard with two plugins" style="width: 100%">

          <aside class="notes">
            <ul>
              <li>Zwei verwaiste Plugins</li>
              <li>Wiederbeleben</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">

          <h2>Verfügbar? <br> Klar!</h2>

          <p><a href="https://github.com/contao-graveyard/stylepicker" target="_blank">https://github.com/contao-graveyard/stylepicker</a></p>
          <p><a href="https://github.com/contao-graveyard/googlemaps" target="_blank">https://github.com/contao-graveyard/googlemaps</a></p>

          <aside class="notes">
            <ul>
              <li>Verfügbar auf GitHub</li>
              <li>Bald auf Packagist (in Version 0.1), gerne contributen</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); align-items: center">
            <p>Stylepicker4ward</p>
            <p>dlh_googlemaps</p>
            <img src="images/extensions/stylepicker_before.png" alt="Stylepicker before" style="width: 100%">
            <img src="images/extensions/maps_before.png" alt="Maps before" style="width: 100%">
          </div>
          <p>Manual installation: copy all files to system/modules/</p>
          <aside class="notes">
            <ul>
              <li>Geforked - Sind noch Contao 3 Module</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Step 1</h3>
          <h4>Blind umschreiben in ein Contao-Manager-Bundle</h4>
        </section>

        <section data-transition="fade">
          <h3>Step 2: Use Rector</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); align-items: center">
            <img src="images/waiting.webp" alt="Person waiting" style="width: 100%">
            <img src="images/rector-change.png" alt="Rector console" style="width: 100%">
          </div>
          <aside class="notes">
            <ul>
                <li>Rector ist ein Refactor Tool, was automatisiert - Komme ich später zu</li>
            </ul>
        </aside>
        </section>

        <section data-transition="fade">
          <h3>Zack feddig</h3>
          <h3>"Re(fa)ctored"</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); align-items: center">
            <p>Stylepicker4ward</p>
            <p>dlh_googlemaps</p>
            <img src="images/extensions/stylepicker_after.png" alt="Stylepicker after" style="width: 100%">
            <img src="images/extensions/maps_after.png" alt="Stylepicker after" style="width: 100%">
          </div>
        </section>

        <section data-transition="fade">
          <h3>Vortrag zu Ende</h3>
        </section>

        <section data-transition="fade">
          <h3>Vortrag zu Ende ... ?</h3>
        </section>

        <section data-transition="fade">
          <img src="images/must_refactor.jpeg" alt="Must refactor" style="width: 68vh">
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="service_container" data-transition="fade">

        <section data-transition="fade">
          <h2>Service Container anstatt $GLOBALS</h2>
        </section>

        <section data-transition="fade">
          <h2>$GLOBALS</h2>
          <p>Teil der Superglobals - interne Variablen, die überall verfügbar sind</p>
          <p>Assoziatives Array, das Referenzen auf alle Variablen enthält</p>
          <aside class="notes">
            <ul>
              <li>Das GLOBALS Array wurde für so ziemlich alles genutzt (Hooks, Cron, Elementregistrierung, etc.)</li>
              <li>Unstrukturiertes Array und Ladereihenfolge ist wichtig</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Service Container</h2>
          <p>Ein PHP-Objekt, welches für die Instanziierung von Objekten bzw. Services zuständig ist.</p>
          <p>Es weiß über seine Abhängigkeiten Bescheid, da alles (vor-)konfiguriert</p>
          <p style="font-size: small"><a href="https://symfony.com/doc/current/components/dependency_injection.html">https://symfony.com/doc/current/components/dependency_injection.html</a></p>
          <aside class="notes">
            <ul>
              <li>Service Container steht immer bereit</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Services</h2>
          <ul>
            <li>PHP Objekte</li>
            <li>Stateless</li>
            <li>Sollen austauschbar sein</li>
            <li>Werden konfiguriert in der "services.yaml"</li>
            <li>Per Default nur eine Instanz / Singleton</li>
            <li>Kann man testen</li>
          </ul>
          <aside class="notes">
            <ul>
              <li>Arbeiterklassen wie Ameisen</li>
              <li>Bestes Beispiel ist immer der Mailer Service, er soll eine E-Mail versenden</li>
              <li>Stateless (gleiche Eingabe -> gleiche Ausgabe)</li>
              <li>Singleton Pattern: Soll nicht mehrfach aufgerufen werden</li>
              <li>shared: false, damit es kein Singleton ist</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Database::getInstance()</h2>
          <pre><code class="php">
class Database
{
  protected function __construct()
	{
		$this->resConnection = System::getContainer()->get('database_connection');

		if (!\is_object($this->resConnection)) {
			throw new \Exception(\sprintf('Could not connect to database (%s)', $this->error));
		}
	}

  public static function getInstance()
  {
    return static::$objInstance ??= new static();
  }
          </code></pre>


          <aside class="notes">
            <ul>
              <li>Wir holen uns immer dieselbe Datenbankinstanz</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Vorher</h2>
          <pre><code class="php">
$objContent = Database::getInstance()
  ->prepare('SELECT type,pid FROM tl_content WHERE id=?')
  ->execute($id)
;

$id = $objContent->pid;
$cond = $objContent->type;
          </code></pre>

          <aside class="notes">
            <ul>
              <li>Wir holen uns immer dieselbe Datenbankinstanz</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Nachher</h2>
          <pre><code class="php">
class StylePickerController extends AbstractBackendController
{
  public function __construct(
    private readonly Connection $connection // Datenbank Service
  ) {}

  // ...
  $objContent = $this->connection->fetchAssociative(
    'SELECT type, pid FROM tl_content WHERE id = ?', [$id]
  );

  $id = $objContent['pid'] ?? null;
  $condition = $objContent['type'] ?? null;
        </code></pre>

          <aside class="notes">
            <ul>
              <li>Der Service ist austauschbar</li>
                <li>Erklären!</li>
            </ul>
          </aside>
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="contao_attribute_tagging" data-transition="fade">

        <section data-transition="fade">
          <h2>Service-Tagging</h2>
          <p>und wie das Contao CMS es für Entwickler vereinfacht</p>
        </section>

        <section data-transition="fade">
          <h3>Beispiel eines Content-Elements</h3>
        </section>

        <section data-transition="fade">
          <h3>Warum sollte ich meine Inhaltselemente umschreiben?</h3>
          <ul>
            <li>Fragment Controller</li>
            <li>Seit Symfony 2.2 (aber auch in 2.0)</li>
            <li>Fragmente = Schnipsel</li>
            <li>Caching von Schnipseln auf der Page (ESI)</li>
            <li>Mit Twig viel mehr möglich :)</li>
          </ul>
        </section>

        <section data-transition="fade">
          <p>Services müssen in der services.yaml definiert werden</p>
          <pre style="width: 100%"><code class="yaml">
services:
    _defaults:
        autoconfigure: true

    ContaoGraveyard\GoogleMapsBundle\Controller\ContentElement\GoogleMapsController:
        tags:
            -
                type: dlh_googlemaps
                name: contao.content_element
                category: media
                template: ce_dlh_googlemaps_default
        </code></pre>
          <aside class="notes">
            <ul>
              <li>Opt-In, komme ich gleich zu (Autowiring)</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h2>Geht das nicht einfacher?</h2>
        </section>

        <section data-transition="fade">
          <h2>Attributes!</h2>
          <p>(früher auch über Annotations)</p>
          <ul style="display: flex; flex-wrap: wrap; list-style: none; gap: 1rem; justify-content: center">
            <li style="padding: 5px; border: 1px solid">AsFrontendModule</li>
            <li style="padding: 5px; border: 1px solid">AsContentElement</li>
            <li style="padding: 5px; border: 1px solid">AsPage</li>
            <li style="padding: 5px; border: 1px solid">AsPickerProvider</li>
            <li style="padding: 5px; border: 1px solid">AsCronJob</li>
            <li style="padding: 5px; border: 1px solid">AsHook</li>
            <li style="padding: 5px; border: 1px solid">AsInsertTag</li>
            <li style="padding: 5px; border: 1px solid">AsBlockInsertTag</li>
            <li style="padding: 5px; border: 1px solid">AsInsertTagFlag</li>
            <li style="padding: 5px; border: 1px solid">AsCallback</li>
          </ul>
          <aside class="notes">
            <ul>
              <li>Contao stellt Attribute bereit, welche dir die Services taggen</li>
              <li>Die fügst du lediglich in deinem Controller hizu</li>
              <li>Technisch geht es zu sehr ins Detail aber Contao konfiguriert diese für dich im Service Container</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3 style="text-transform: initial">#[AsContentElement]</h3>
          <pre><code class="php">
#[AsContentElement(
    type: 'dlh_googlemaps',
    category: 'media',
    template: 'ce_dlh_googlemaps_default',
)]
class GoogleMapsController extends AbstractContentElementController
{
          </code></pre>
        </section>

        <section data-transition="fade">
          <p>Und nun?</p>
          <pre style="width: 100%"><code class="yaml">
services:
    _defaults:
        autoconfigure: true

    #ContaoGraveyard\GoogleMapsBundle\Controller\ContentElement\GoogleMapsController: ~
    ...ContentElement\GoogleMapsController: ~

    # Yes, it's invalid, I know
          </code></pre>
        </section>

        <section data-transition="fade">
          <h3>Aber was ist mit Autowiring!?</h3>
          <img src="images/service/autowiring.png" alt="Man looking at autowire being nice" style="height: 50vh">

        </section>

        <section data-transition="fade">
          <p>Klar, kannst du machen!</p>
          <pre class="stretch"><code class="yaml">
services:
    _defaults:
        autoconfigure: true
        autowire: true

    ContaoGraveyard\GoogleMapsBundle\:
        resource: '../src/'
        exclude: '../src/{Event,Model,Whatever.php}'
          </code></pre>

        </section>

        <section data-transition="fade">
          <h3>Aber nicht in public bundles!</h3>
          <p>Mr. Codestyle wants to talk to you</p>
          <img src="images/service/autowire_you_must_not.png" alt="Leo not allowing autowiring" style="height: 50vh">
        </section>

        <section data-transition="fade">
          <p>Public Bundles kennen die Services in deinem Container nicht (in der Theorie)</p>
          <p>In der App hat man Kontrolle über alles</p>
          <aside class="notes">
            <ul>
              <li>Der Service Container kann von jedem konfiguriert werden</li>
              <li>Services könnten sich ändern</li>
              <li>Dein Bundle soll es speziell konfigurieren :)</li>
            </ul>
          </aside>
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="permissions" data-transition="fade">

        <section data-transition="fade">
          <h2>Permissions und Voter</h2>
          <aside class="notes">
            <ul>
              <li>Was bringt Contao mit?</li>
              <li>Warum auf Voter setzen?</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <p>Warum?</p>
          <ul>
            <li>Legacygründe: man hat immer alle Berechtigungen</li>
            <li>Und verweigert danach</li>
            <li>Nicht mehr selber Berechtigungen schreiben</li>
            <li>Lass es das Framework machen</li>
            <li>C R U D</li>
          </ul>
        </section>

        <section data-transition="fade">
          <h2>Wie ging es damals?</h2>
          <p>DO NOT CHANGE THIS ORDER!</p>
          <pre class="stretch"><code class="php">
/**
 * Initialize the controller.
 *
 * 1. Import user
 * 2. Call parent constructor
 * 3. Authenticate user
 * 4. Load language files
 * DO NOT CHANGE THIS ORDER!
 */
public function __construct()
{
    $this->import(BackendUser::class, 'User');
    $this->import('Database');

    $this->User->authenticate();

    $this->loadLanguageFile('default');
    $this->loadLanguageFile('modules');
}
          </code></pre>
        </section>

        <section data-transition="fade">
          <p>onLoadCallback!</p>
        </section>

        <section data-transition="fade">
          <pre class="stretch"><code class="php">
$GLOBALS['TL_DCA']['tl_dlh_googlemaps'] = [
    'config' => [
        // ...
        'onload_callback' => [
            ['tl_dlh_googlemaps', 'checkPermission'],
        ],
    ],
    //...

public function checkPermission(): void
{
    if ($this->User->isAdmin) {
        return;
    }
    // Set root IDs
    if (!is_array($this->User->dlh_googlemapss) || $this->User->dlh_googlemapss === []) {
        $root = [0];
    } else {
        $root = $this->User->dlh_googlemapss;
    }
    $GLOBALS['TL_DCA']['tl_dlh_googlemaps']['list']['sorting']['root'] = $root;
    // Check permissions to add Maps
    if (!$this->User->hasAccess('create', 'dlh_googlemapsp')) {
        $GLOBALS['TL_DCA']['tl_dlh_googlemaps']['config']['closed'] = \true;
    }
          </code></pre>
        </section>
        <section data-transition="fade">
          <pre class="stretch"><code class="php">
// Check current action
switch (Input::get('act')) {
    case 'create':
    case 'select':
        // Allow
        break;
          </code></pre>
        </section>

        <section data-transition="fade">
          <pre class="stretch"><code class="php">
    case 'edit':
        // Dynamically add the record to the user profile
        if (!in_array(Input::get('id'), $root, true)) {
            $arrNew = $this->Session->get('new_records');
            if (is_array($arrNew['tl_dlh_googlemaps']) && in_array(Input::get('id'), $arrNew['tl_dlh_googlemaps'], true)) {
                // Viel Code um Berechtigungen auf Gruppenepene upzudaten
                // ...
            }
        }
        // no break;
    case 'copy':
    case 'delete':
    case 'show':
        if (!in_array(Input::get('id'), $root, true) || (Input::get('act') === 'delete' && !$this->User->hasAccess('delete', 'dlh_googlemapsp'))) {
            System::getContainer()->get('monolog.logger.contao')->log(
                LogLevel::ERROR,
                'Not enough permissions to ' . Input::get('act') . ' Map ID "' . Input::get('id') . '"',
                [
                    'contao' => new ContaoContext(__METHOD__, ContaoContext::ERROR),
                ],
            );
            $this->redirect('contao/main.php?act=error');
        }
        break;
          </code></pre>
        </section>

        <section data-transition="fade">
          <pre class="stretch"><code class="php">
case 'editAll':
    case 'deleteAll':
    case 'overrideAll':
        $session = $this->Session->getData();
        if (Input::get('act') === 'deleteAll' && !$this->User->hasAccess('delete', 'dlh_googlemapsp')) {
            $session['CURRENT']['IDS'] = [];
        } else {
            $session['CURRENT']['IDS'] = array_intersect($session['CURRENT']['IDS'], $root);
        }
        $this->Session->setData($session);
        break;

    default:
        if ((string) Input::get('act') !== '') {
            System::getContainer()->get('monolog.logger.contao')->log(
                LogLevel::ERROR,
                'Not enough permissions to ' . Input::get('act') . ' Maps',
                [
                    'contao' => new ContaoContext(__METHOD__, ContaoContext::ERROR),
                ],
            );
            $this->redirect('contao/main.php?act=error');
        }
        break;
}
          </code></pre>
        </section>

        <section data-transition="fade">
          <h3>Voters</h3>
          <p>This feature is available in Contao <strong style="color: #f47c00;">4.7</strong> and later.</p>
          <p>This feature is available in Contao <strong style="color: #f47c00;">4.10</strong> and later.</p>
          <p>This feature is available in Contao <strong style="color: #f47c00;">4.12</strong> and later.</p>
          <p>This feature is available in Contao <strong style="color: #f47c00;">5.0</strong> and later.</p>
        </section>

        <section data-transition="fade">
          <h3>Jetzt aber!</h3>
          <pre class="stretch"><code class="php" style="font-size: 18px">
class GoogleMapsAccessVoter extends AbstractDataContainerVoter
{
    public function __construct(private readonly AccessDecisionManagerInterface $accessDecisionManager)
            {}

    protected function getTable(): string
    {
        return 'tl_dlh_googlemaps';
    }

    protected function hasAccess(TokenInterface $token, CreateAction|DeleteAction|ReadAction|UpdateAction $action): bool
    {
        if (!$this->accessDecisionManager->decide($token, [ContaoCorePermissions::USER_CAN_ACCESS_MODULE . '.dlh_googlemaps'])) {
            return false;
        }

        return match (true) {
            $action instanceof CreateAction => $this->accessDecisionManager->decide($token, ['contao_user.dlh_googlemapsp'], 'create'),
            $action instanceof ReadAction,
            $action instanceof UpdateAction => $this->accessDecisionManager->decide($token, ['contao_user.dlh_googlemapss'], (int) $action->getCurrentId()),
            $action instanceof DeleteAction => $this->accessDecisionManager->decide($token, ['contao_user.dlh_googlemapss'], (int) $action->getCurrentId())
                && $this->accessDecisionManager->decide($token, ['contao_user.dlh_googlemapsp'], 'delete'),
        };
    }
}
          </code></pre>
        </section>

        <section data-transition="fade">
          <h3>Permissions mit CRUD erledigt</h3>
          <p>Jetzt erstmal löschen!</p>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); align-items: center;">
            <img src="images/permissions/overview.png" alt="Setting permissions in the group" style="width: 100%">
            <img src="images/permissions/editor_view.png" alt="Overview of operations for a record" style="width: 100%">
          </div>
          <aside class="notes">
            <ul>
              <li>Hinweis, muss man immer selber programmieren</li>
              <li>Ah, die Button Callbacks fehlen noch ... Man darf es ja nicht erlauben</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Oh... Forbidden</h3>
          <p>Es fehlen die Button-Callbacks ...</p>
          <img src="images/permissions/forbidden.png" alt="Forbidden" style="width: 100%">
        </section>

        <section data-transition="fade">
          <h3>Dafür gibt es jetzt den OperationsBuilder</h3>
          <img src="images/permissions/operations_builder.png" alt="Diff of deleting operations and using the operations builder" style="width: 100%">
        </section>

        <section data-transition="fade">
          <pre class="stretch"><code class="php" style="font-size: 18px">
    'label' => [
        'fields' => ['title'],
        'format' => '%s',
        'label_callback' => ['tl_dlh_googlemaps', 'listRecords'],
    ],
    'global_operations' => [
        'all',
    ],
    'operations' => [
        'edit',
        'children',
        'copy',
        'delete',
        'show',
    ],
],
          </code></pre>
          <p>* Seit Contao 5.5 kann man die Defaults auch weglassen</p>
        </section>

        <section data-transition="fade">
          <p>Kaum löscht man paar Zeilen Code</p>
          <p>Hat man das Feature implementiert</p>
          <img src="images/permissions/permissions_correct.png" alt="Operations with greyed out permissions" style="width: 100%">
        </section>

      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="events_not_hooks" data-transition="fade">

        <section data-transition="fade">
          <h2>Events statt Hooks!</h2>
          <aside class="notes">
            <ul>
              <li>Was bringt Contao mit?</li>
              <li>Warum auf Voter setzen?</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Aber warum?</h3>
          <ul>
            <li>Hooks greifen auf Globals zu (deprecated)</li>
            <li>... ich, Ich, ICH! ICH MUSS ZUERST! (Priority)</li>
            <li>Events kannst du "decoraten"! (überschreiben)</li>
            <li>Events sind Objekte</li>
          </ul>
          <aside class="notes">
            <ul>
              <li>Priority bestimmt die Ladereihenfolge - Höchste zuerst</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Als Hook</h3>
          <pre class=""><code class="php" style="font-size: 18px">
if (isset($GLOBALS['TL_HOOKS']['stylepicker4ward_getFilter']) && is_array($GLOBALS['TL_HOOKS']['stylepicker4ward_getFilter'])) {
    foreach ($GLOBALS['TL_HOOKS']['stylepicker4ward_getFilter'] as $callback) {
        System::importStatic($callback[0]);
        $result = $this->{$callback[0]}->{$callback[1]}($table, $id);
        if (is_array($result)) {
            [$table, $layout, $section, $condition] = $result;
            break;
        }
    }
}
          </code></pre>
          <aside class="notes">
            <ul>
              <li>Ob es ein Pointer, also ein Zeiger ist, das muss man im Hook selber implementieren</li>
              <li>Man kann Mist hereinschreiben</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Als Event</h3>
          <pre class=""><code class="php" style="font-size: 18px">
$event = new GetStylePickerFilterEvent($table, (int) $id);
$this->eventDispatcher->dispatch($event);

$layout = $event->getLayout();
$section = $event->getSection();
$condition = $event->getCondition();
          </code></pre>
          <aside class="notes">
            <ul>
              <li>Events sind Objekte</li>
              <li>Referenzen oder Pointer nicht notwendig, du modifizierst das Objekt</li>
              <li></li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Und darauf kannst du hören (EventListener)</h3>
          <pre class="stretch"><code class="php" style="font-size: 18px">
#[AsEventListener]
class StylePickerEventListener
{
    public function __invoke(GetStylePickerFilterEvent $event): void
    {
        if ($event->getTable() !== 'my_table') {
            return;
        }

        $event->setLayout(213);
        $event->setCondition('foobar');
        $event->setSection('your_section');
    }
}
          </code></pre>
          <aside class="notes">
            <ul>
              <li>Das Attribut kann auch auf der Methode angewandt werden (MultiListener)</li>
            </ul>
          </aside>
        </section>
      </section>

      <!-- ------------------------------------------------------------------------------------------------------- -->

      <section id="rector_and_more" data-transition="fade">

        <section data-transition="fade">
          <h2>Rector (und andere Tools)</h2>
          <aside class="notes">
            <ul>
              <li>Rector alleine reicht nicht aus</li>
              <li>Nutzung von ECS und Rector</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>Übersicht</h3>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>Meldet Fehler</th>
                <th>Fixed Fehler</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Coding standard</th>
                <td>PHP_Codesniffer</td>
                <td>PHP-CS-Fixer, ECS</td>
              </tr>
              <tr>
                <th>Logik</th>
                <th>PHPStan, Psalm</th>
                <th>Rector</th>
              </tr>
            </tbody>
          </table>

          <aside class="notes">
            <ul>
              <li>Rector von Tomas Votruba</li>
              <li>Rector erkennt Logik und behebt diese Fehler auch</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h4>Coding Standard</h4>
          <p>Modifiziert Code und ist Token-Basiert (Lexing und Tokenisierung)</p>
          <p>PHPToken oder `token_get_all`</p>

          <pre class="stretch"><code class="php">
$source = <<<'code'
<?php

class A
{
    const PUBLIC = 1;
}
code;

$tokens = token_get_all($source, TOKEN_PARSE);

foreach ($tokens as $token) {
    if (is_array($token)) {
        echo token_name($token[0]) , PHP_EOL;
    }
}
?>
          </code></pre>

        </section>

        <section data-transition="fade">
                    <pre><code>
T_OPEN_TAG
T_WHITESPACE
T_CLASS
T_WHITESPACE
T_STRING
T_CONST
T_WHITESPACE
T_STRING
T_LNUMBER
          </code></pre>
        </section>

        <section data-transition="fade">

          <h4>Static analyzers</h4>
          <p>Basierend auf dem AST (Abstract Syntax Tree) -> Seit PHP 7</p>
          <p>Geparsed über PHPParser <br><sup>(by Nikita Popov / nikic)</sup></p>

          <pre><code class="php">
            return $this->foo && self::bar();```
          </code></pre>
          <pre><code class="php">
PhpParser\Node\Stmt\Return_
└─ expr: PhpParser\Node\Expr\BinaryOp\BooleanAnd
   ├─ left:  PhpParser\Node\Expr\PropertyFetch
   |         ├─ var:  PhpParser\Node\Expr\Variable
   |         └─ name: PhpParser\Node\Identifier
   └─ right: PhpParser\Node\Expr\StaticCall
             ├─ class: PhpParser\Node\Name
             ├─ name:  PhpParser\Node\Identifier
             └─ args:  array()
          </code></pre>

        </section>

        <section data-transition="fade">
          <h4>Instant Upgrade Tools</h4>
          <p>RectorPHP <br><sup>(by Tomas Votruba)</sup></p>
        </section>

        <section data-transition="fade">
          <pre><code class="php">
class Foo extends \Controller
{
    public function bar()
    {
        $GLOBALS['TL_DCA']['tl_content']['palettes']['foo'] = '{foo_legend},foo;{bar_legend:hide},bar;{baz_legend:hide},baz';
    }
}
          </code></pre>
        </section>

        <section data-transition="fade">
          <img src="images/ast_dca.png" alt="Abstract Syntax Tree of a DCA" style="width: 100%">
          <a href="https://getrector.com/ast/9e097952b5402901fe0b3d4dc769b3337265818e">Beispiel</a>
        </section>

        <section data-transition="fade">
          <img src="images/contao-rector.png" alt="Contao-Rector" style="width: 100%">
          <a href="https://getrector.com/ast/9e097952b5402901fe0b3d4dc769b3337265818e">Beispiel</a>

          <aside class="notes">
            <ul>
              <li>Jemand war faul und wollte nicht immer dasselbe wiederholen</li>
            </ul>
          </aside>
        </section>

        <section data-transition="fade">
          <h3>rector.php</h3>
          <pre><code class="php" style="font-size: .8em; line-height: 1;">

return RectorConfig::configure()
    ->withPhpSets(
        php83: true,
    )
    ->withAttributesSets(
        symfony: true,
        doctrine: true,
    )
    ->withSets([
        ContaoLevelSetList::UP_TO_CONTAO_53,
        ContaoSetList::ANNOTATIONS_TO_ATTRIBUTES,
    ])
    ->withPaths([
        __DIR__ . '/contao',
        __DIR__ . '/src',
    ])
    ->withImportNames(removeUnusedImports: true)
    ->withParallel()
;
          </code></pre>
        </section>

        </section>

        <!-- ------------------------------------------------------------------------------------------------------- -->

        <section id="write-rector-rules" data-transition="fade">
          <h2>Rector Regeln schreiben (optional)</h2>
          <p>Note to yourself, open the IDE</p>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------- -->

        <section id="ending" data-transition="fade">
          <h2>Fragerunde</h2>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------- -->

        <section id="thank-you" data-transition="fade">
          <h2>Danke fürs Zuhören!</h2>
        </section>

        <!-- ------------------------------------------------------------------------------------------------------- -->

    </div>
    </div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
